name: Setup Environment
description: A reusable composite action to setup the environment.
inputs:
  os:
    description: The operating system to setup.
    required: true
  node-version:
    description: The Node.js version to setup.
    required: true
  architecture:
    description: The architecture to setup the node.js.
    required: true
runs:
  using: composite
  steps:
    - uses: actions/setup-node@v4
      with:
        architecture: ${{ inputs.architecture }}
        node-version: ${{ inputs.node-version }}
        registry-url: "https://registry.npmjs.org"

    - name: Install Linux packages
      if: contains(inputs.os, 'ubuntu')
      run: sudo apt update && sudo apt install -y libxml2-dev
      shell: bash

    - name: Install macOS packages
      if: contains(inputs.os, 'macos')
      run: brew install libxml2 pkg-config
      shell: bash

    - name: Install Windows packages
      if: contains(inputs.os, 'windows')
      shell: pwsh
      run: |
        if ("${{ inputs.architecture }}" -eq "x86") {
          $TRIPLET = "x86-windows"
        } else {
          Write-Error "Unsupported Windows architecture: ${{ inputs.architecture }}"
          exit 1
        }

        Write-Host "Installing libxml2:$TRIPLET..."
        & C:\vcpkg\vcpkg.exe install libxml2:$TRIPLET
        if ($LASTEXITCODE -ne 0) {
          Write-Error "Failed to install libxml2"
          exit 1
        }

        $VCPKG_ROOT = "C:\vcpkg"
        $LIBXML2_DIR = "$VCPKG_ROOT\installed\$TRIPLET\include"
        $LIBXML2_LIB = "$VCPKG_ROOT\installed\$TRIPLET\lib\xml2.lib"

        if (-not (Test-Path "$LIBXML2_DIR\libxml\parser.h")) {
          Write-Error "libxml2 headers not found at $LIBXML2_DIR\libxml\parser.h"
          Write-Host "Contents of $LIBXML2_DIR:"
          Get-ChildItem $LIBXML2_DIR -ErrorAction SilentlyContinue | Select-Object -First 10
          exit 1
        }

        if (-not (Test-Path $LIBXML2_LIB)) {
          Write-Error "libxml2 library not found at $LIBXML2_LIB"
          Write-Host "Contents of $VCPKG_ROOT\installed\$TRIPLET\lib:"
          Get-ChildItem "$VCPKG_ROOT\installed\$TRIPLET\lib" -ErrorAction SilentlyContinue | Select-Object -First 10
          exit 1
        }

        Write-Host "Setting LIBXML2_DIR=$LIBXML2_DIR"
        Write-Host "Setting LIBXML2_LIB=$LIBXML2_LIB"

        $LIBXML2_DIR_NORMALIZED = $LIBXML2_DIR -replace '\\', '/'
        $LIBXML2_LIB_NORMALIZED = $LIBXML2_LIB -replace '\\', '/'

        "LIBXML2_DIR=$LIBXML2_DIR_NORMALIZED" | Out-File -FilePath $env:GITHUB_ENV -Append
        "LIBXML2_LIB=$LIBXML2_LIB_NORMALIZED" | Out-File -FilePath $env:GITHUB_ENV -Append

    - name: Install pnpm
      run: |
        npm install -g npm@latest
        npm install -g pnpm
      shell: bash
