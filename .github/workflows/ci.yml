name: CI

on:
  pull_request:
    types: [opened, synchronize]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ci:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            arch: x64
            node-version: 22.x
          - os: windows-latest
            arch: x64
            node-version: 22.x
          - os: macos-latest
            arch: arm64
            node-version: 22.x

    runs-on: ${{ matrix.os }}

    env:
      NFETS_ADDONS_DIR: "${{ github.workspace }}/build/Release"
      NFETS_NFE_SCHEMAS_DIR: "${{ github.workspace }}/packages/nfe/schemas"

    steps:
      - uses: actions/checkout@v4

      - name: Setup environment
        uses: ./.github/actions/setup-environment
        with:
          os: ${{ matrix.os }}

      - name: Setup Node.js
        uses: ./.github/actions/setup-nodejs
        with:
          os: ${{ matrix.os }}
          architecture: ${{ matrix.arch }}
          node-version: ${{ matrix.node-version }}

      - name: Install dependencies, Rebuild addons and Build package
        run: |
          make install
          make addon
          make build

      - name: Install test certificates (Windows only)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          $password = ConvertTo-SecureString -String "123456" -Force -AsPlainText
          $certPath = "${{ github.workspace }}/packages/test/fixtures/certificates"

          if (Test-Path "$certPath/certificate_79839601000142.pfx") {
            Import-PfxCertificate `
              -FilePath "$certPath/certificate_79839601000142.pfx" `
              -Password $password `
              -CertStoreLocation Cert:\CurrentUser\My `
              -ErrorAction Stop
            Write-Host "Installed CNPJ certificate"
          }

          if (Test-Path "$certPath/certificate_61094730068.pfx") {
            Import-PfxCertificate `
              -FilePath "$certPath/certificate_61094730068.pfx" `
              -Password $password `
              -CertStoreLocation Cert:\CurrentUser\My `
              -ErrorAction Stop
            Write-Host "Installed CPF certificate"
          }

      - name: Run lint
        run: make lint

      - name: Run unit/integration tests
        run: make test
