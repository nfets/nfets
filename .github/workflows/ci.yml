name: CI

on:
  pull_request:
    types: [opened, synchronize]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ci:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            arch: x64
            node-version: 22.x
          - os: windows-latest
            arch: x64
            node-version: 22.x
          - os: macos-latest
            arch: arm64
            node-version: 22.x

    runs-on: ${{ matrix.os }}

    env:
      NFETS_ADDONS_DIR: "${{ github.workspace }}/build/Release"
      NFETS_NFE_SCHEMAS_DIR: "${{ github.workspace }}/packages/nfe/schemas"

    steps:
      - uses: actions/checkout@v4

      - name: Setup environment
        uses: ./.github/actions/setup-environment
        with:
          os: ${{ matrix.os }}

      - name: Setup Node.js
        uses: ./.github/actions/setup-nodejs
        with:
          os: ${{ matrix.os }}
          architecture: ${{ matrix.arch }}
          node-version: ${{ matrix.node-version }}

      - name: Install dependencies, Rebuild addons and Build package
        run: |
          make install
          make addon
          make build

      - name: Install test certificates (Windows only)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          $password = "123456"
          $certPath = "${{ github.workspace }}/packages/test/fixtures/certificates"

          function Import-TestCertificate {
            param(
              [string]$PfxPath,
              [string]$CertPassword,
              [string]$CertName
            )

            Write-Host "Importing $CertName certificate..."

            $securePassword = ConvertTo-SecureString -String $CertPassword -Force -AsPlainText
            $pfxBytes = [System.IO.File]::ReadAllBytes($PfxPath)

            # Use flags that allow private key access similar to GUI import:
            # - Exportable: Allow key export (enables access to private key)
            # - PersistKeySet: Persist the key in the key container (required for proper access)
            # Note: UserKeySet is the default for CurrentUser, but we explicitly set it to match GUI behavior
            $flags = [System.Security.Cryptography.X509Certificates.X509KeyStorageFlags]::PersistKeySet -bor
                     [System.Security.Cryptography.X509Certificates.X509KeyStorageFlags]::UserKeySet

            $cert = New-Object System.Security.Cryptography.X509Certificates.X509Certificate2(
              $pfxBytes,
              $securePassword,
              $flags
            )

            $store = New-Object System.Security.Cryptography.X509Certificates.X509Store(
              [System.Security.Cryptography.X509Certificates.StoreName]::My,
              [System.Security.Cryptography.X509Certificates.StoreLocation]::CurrentUser
            )
            $store.Open([System.Security.Cryptography.X509Certificates.OpenFlags]::ReadWrite)

            try {
              $store.Add($cert)
              Write-Host "Imported $CertName certificate with thumbprint: $($cert.Thumbprint)"
            }
            finally {
              $store.Close()
            }

            $certWithKey = Get-ChildItem Cert:\CurrentUser\My\$($cert.Thumbprint) -ErrorAction SilentlyContinue
            if ($certWithKey) {
              Write-Host "Certificate found in store. HasPrivateKey: $($certWithKey.HasPrivateKey)"
            }
          }

          if (Test-Path "$certPath/certificate_79839601000142.pfx") {
            Import-TestCertificate `
              -PfxPath "$certPath/certificate_79839601000142.pfx" `
              -CertPassword $password `
              -CertName "CNPJ"
          }

          if (Test-Path "$certPath/certificate_61094730068.pfx") {
            Import-TestCertificate `
              -PfxPath "$certPath/certificate_61094730068.pfx" `
              -CertPassword $password `
              -CertName "CPF"
          }

          Write-Host "`nInstalled certificates in CurrentUser\My store:"
          Get-ChildItem Cert:\CurrentUser\My | Select-Object Thumbprint, Subject | Format-Table

      - name: Run lint
        run: make lint

      - name: Run unit/integration tests
        run: make test
