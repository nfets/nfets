name: CI

on:
  pull_request:
    types: [opened, synchronize]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ci:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            arch: x64
            node-version: 22.x
          - os: windows-latest
            arch: x64
            node-version: 22.x
          - os: macos-latest
            arch: arm64
            node-version: 22.x

    runs-on: ${{ matrix.os }}

    env:
      NFETS_ADDONS_DIR: "${{ github.workspace }}/build/Release"
      NFETS_NFE_SCHEMAS_DIR: "${{ github.workspace }}/packages/nfe/schemas"

    steps:
      - uses: actions/checkout@v4

      - name: Setup environment
        uses: ./.github/actions/setup-environment
        with:
          os: ${{ matrix.os }}

      - name: Setup Node.js
        uses: ./.github/actions/setup-nodejs
        with:
          os: ${{ matrix.os }}
          architecture: ${{ matrix.arch }}
          node-version: ${{ matrix.node-version }}

      - name: Install dependencies, Rebuild addons and Build package
        run: |
          make install
          make addon
          make build

      - name: Install test certificates (Windows only)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          $password = "123456"
          $certPath = "${{ github.workspace }}/packages/test/fixtures/certificates"

          function Import-TestCertificate {
            param(
              [string]$PfxPath,
              [string]$CertPassword,
              [string]$CertName
            )

            $securePassword = ConvertTo-SecureString -String $CertPassword -Force -AsPlainText

            Write-Host "Importing $CertName certificate..."

            $certutilResult = & certutil -f -p $CertPassword -importPFX -user "$PfxPath" 2>&1
            if ($LASTEXITCODE -eq 0) {
              Write-Host "Imported $CertName certificate using certutil"
              return
            }

            Write-Host "certutil failed, using Import-PfxCertificate..."
            $cert = Import-PfxCertificate `
              -FilePath $PfxPath `
              -Password $securePassword `
              -CertStoreLocation Cert:\CurrentUser\My `
              -KeyExportPolicy Exportable `
              -ErrorAction Stop

            Write-Host "Imported $CertName certificate with thumbprint: $($cert.Thumbprint)"

            # Note: Certificates imported from PFX files created with legacy CSPs
            # will remain in legacy CSPs and may not fully support CNG operations.
            # SHA1 signing should work fine (uses CSP), but SHA256 may fail if the
            # certificate is acquired as CNG but the underlying provider is CSP-based.
            # This is a known limitation - see test comment: "SHA256 is not working"
          }

          if (Test-Path "$certPath/certificate_79839601000142.pfx") {
            Import-TestCertificate `
              -PfxPath "$certPath/certificate_79839601000142.pfx" `
              -CertPassword $password `
              -CertName "CNPJ"
          }

          if (Test-Path "$certPath/certificate_61094730068.pfx") {
            Import-TestCertificate `
              -PfxPath "$certPath/certificate_61094730068.pfx" `
              -CertPassword $password `
              -CertName "CPF"
          }

          Write-Host "`nInstalled certificates in CurrentUser\My store:"
          Get-ChildItem Cert:\CurrentUser\My | Select-Object Thumbprint, Subject | Format-Table

      - name: Run lint
        run: make lint

      - name: Run unit/integration tests
        run: make test
