name: CD

on:
  push:
    branches: ["main"]

permissions:
  contents: write
  id-token: write

jobs:
  build-native-addons:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            arch: x64
          - os: windows-latest
            arch: ia32
          - os: macos-latest
            arch: arm64
          - os: macos-latest
            arch: x64

    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - id: should-skip-cd
        uses: ./.github/actions/should-skip-cd

      - id: get-artifact-name
        if: steps.should-skip-cd.outputs.skip != 'true'
        run: |
          if [ "${{ matrix.os }}" == "ubuntu-latest" ] && [ "${{ matrix.arch }}" == "x64" ]; then
            echo "artifact_name=xml_validator-linux-x64" >> $GITHUB_OUTPUT
          elif [ "${{ matrix.os }}" == "windows-latest" ] && [ "${{ matrix.arch }}" == "ia32" ]; then
            echo "artifact_name=xml_validator-win32-ia32" >> $GITHUB_OUTPUT
          elif [ "${{ matrix.os }}" == "macos-latest" ] && [ "${{ matrix.arch }}" == "arm64" ]; then
            echo "artifact_name=xml_validator-macos-arm64" >> $GITHUB_OUTPUT
          elif [ "${{ matrix.os }}" == "macos-latest" ] && [ "${{ matrix.arch }}" == "x64" ]; then
            echo "artifact_name=xml_validator-macos-x64" >> $GITHUB_OUTPUT
          else
            echo "Unsupported platform: ${{ matrix.os }} ${{ matrix.arch }}"
            exit 1
          fi

      - id: check-artifact-expiration
        if: steps.should-skip-cd.outputs.skip != 'true'
        run: |
          ARTIFACT_NAME="${{ steps.get-artifact-name.outputs.artifact_name }}"

          ARTIFACT_CREATED_AT=$(gh api repos/${{ github.repository }}/actions/artifacts --jq ".artifacts[] | select(.name == \"$ARTIFACT_NAME\") | .created_at" | head -1 || echo "")

          if [ -z "$ARTIFACT_CREATED_AT" ]; then
            echo "Artifact $ARTIFACT_NAME not found"
            echo "artifact_exists=false" >> $GITHUB_OUTPUT
            echo "artifact_expired=true" >> $GITHUB_OUTPUT
          else
            echo "artifact_exists=true" >> $GITHUB_OUTPUT
            echo "artifact_created_at=$ARTIFACT_CREATED_AT" >> $GITHUB_OUTPUT

            PYTHON_CODE="from datetime import datetime, timezone; created = datetime.fromisoformat('$ARTIFACT_CREATED_AT'.replace('Z', '+00:00')); now = datetime.now(timezone.utc); days = (now - created).days; print(days)"
            DAYS_OLD=$(python3 -c "$PYTHON_CODE" 2>/dev/null || echo "999")

            echo "Artifact $ARTIFACT_NAME created $DAYS_OLD days ago"
            echo "artifact_days_old=$DAYS_OLD" >> $GITHUB_OUTPUT

            if [ "$DAYS_OLD" -ge 90 ]; then
              echo "Artifact expired (90+ days old)"
              echo "artifact_expired=true" >> $GITHUB_OUTPUT
            else
              echo "Artifact is still valid ($DAYS_OLD days old)"
              echo "artifact_expired=false" >> $GITHUB_OUTPUT
            fi
          fi

      - id: check-changes-or-artifact-expired
        if: steps.should-skip-cd.outputs.skip != 'true'
        run: |
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$LATEST_TAG" ]; then
            echo "No tags found, checking against initial commit"
            BASE_REF=$(git rev-list --max-parents=0 HEAD)
          else
            BASE_REF="$LATEST_TAG"
            echo "Comparing against latest tag: $LATEST_TAG"
          fi

          ADDONS_CHANGED=$(git diff --name-only --diff-filter=AM "$BASE_REF" HEAD -- "addons/" | wc -l | tr -d ' ')
          BINDING_CHANGED=$(git diff --name-only --diff-filter=M "$BASE_REF" HEAD -- "binding.gyp" | wc -l | tr -d ' ')

          echo "Addons folder changes: $ADDONS_CHANGED"
          echo "binding.gyp changes: $BINDING_CHANGED"

          ARTIFACT_EXPIRED="${{ steps.check-artifact-expiration.outputs.artifact_expired }}"

          if [ "$ADDONS_CHANGED" -gt 0 ] || [ "$BINDING_CHANGED" -gt 0 ] || [ "$ARTIFACT_EXPIRED" = "true" ]; then
            echo "Rebuild required: changes=$([ "$ADDONS_CHANGED" -gt 0 ] || [ "$BINDING_CHANGED" -gt 0 ] && echo "yes" || echo "no"), expired=$ARTIFACT_EXPIRED"
            echo "skip=false" >> $GITHUB_OUTPUT
          else
            echo "No rebuild needed: no changes and artifact is valid"
            echo "skip=true" >> $GITHUB_OUTPUT
          fi

      - uses: ./.github/actions/setup-environment
        if: steps.check-changes-or-artifact-expired.outputs.skip != 'true' && steps.should-skip-cd.outputs.skip != 'true' && matrix.arch == 'ia32'
        with:
          os: ${{ matrix.os }}
          architecture: x86
          node-version: 22.x

      - uses: ./.github/actions/setup-environment
        if: steps.check-changes-or-artifact-expired.outputs.skip != 'true' && steps.should-skip-cd.outputs.skip != 'true' && matrix.arch != 'ia32'
        with:
          os: ${{ matrix.os }}
          architecture: ${{ matrix.arch }}
          node-version: 22.x

      - name: Build native addon
        if: steps.check-changes-or-artifact-expired.outputs.skip != 'true' && steps.should-skip-cd.outputs.skip != 'true'
        env:
          npm_config_arch: ${{ matrix.arch }}
        run: |
          pnpm node-gyp rebuild --arch=${{ matrix.arch }}

      - name: Verify binaries
        if: steps.check-changes-or-artifact-expired.outputs.skip != 'true' && steps.should-skip-cd.outputs.skip != 'true'
        run: |
          files=$(ls build/Release/*.node || echo "")
          for file in $files; do
            file $file || echo "file command not available"
          done

      - name: Upload artifact
        if: steps.check-changes-or-artifact-expired.outputs.skip != 'true' && steps.should-skip-cd.outputs.skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.get-artifact-name.outputs.artifact_name }}
          path: build/Release/*.node
          retention-days: 90

  build-and-deploy:
    needs: build-native-addons
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            arch: x64

    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - id: should-skip-cd
        uses: ./.github/actions/should-skip-cd

      - uses: ./.github/actions/setup-environment
        if: steps.should-skip-cd.outputs.skip != 'true'
        with:
          os: ${{ matrix.os }}
          architecture: ${{ matrix.arch }}
          node-version: 22.x

      - name: build package
        if: steps.should-skip-cd.outputs.skip != 'true'
        run: make build

      - name: Get next version
        if: steps.should-skip-cd.outputs.skip != 'true'
        id: version
        run: |
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$LATEST_TAG" ]; then
            CURRENT_VERSION=$(jq -r '.version' package.json)
            echo "No tags found, using package.json version: $CURRENT_VERSION"
          else
            CURRENT_VERSION="${LATEST_TAG#v}"
            echo "Latest tag: $LATEST_TAG, version: $CURRENT_VERSION"
          fi

          IFS='.' read -r -a VERSION_PARTS <<< "$CURRENT_VERSION"
          MAJOR="${VERSION_PARTS[0]:-0}"
          MINOR="${VERSION_PARTS[1]:-0}"
          PATCH="${VERSION_PARTS[2]:-0}"

          NEW_PATCH=$((PATCH + 1))
          NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"

          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Configure git
        if: steps.should-skip-cd.outputs.skip != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - uses: actions/download-artifact@v4
        if: steps.should-skip-cd.outputs.skip != 'true'
        with:
          path: build/addons

      # - name: Create and push tag
      #   if: steps.should-skip-cd.outputs.skip != 'true'
      #   run: |
      #     TAG="${{ steps.version.outputs.tag }}"
      #     VERSION="${{ steps.version.outputs.version }}"

      #     if git rev-parse "$TAG" >/dev/null 2>&1; then
      #       echo "Tag $TAG already exists, skipping..."
      #       exit 0
      #     fi

      #     git tag -a "$TAG" -m "Release $VERSION"
      #     git push origin "$TAG"

      # - name: Create release
      #   if: steps.should-skip-cd.outputs.skip != 'true'
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #   run: |
      #     TAG="${{ steps.version.outputs.tag }}"
      #     VERSION="${{ steps.version.outputs.version }}"

      #     gh release create "$TAG" \
      #         --repo="$GITHUB_REPOSITORY" \
      #         --title="${GITHUB_REPOSITORY#*/} $VERSION" \
      #         --generate-notes

      # - name: Update package.json version
      #   if: steps.should-skip-cd.outputs.skip != 'true'
      #   run: |
      #     VERSION="${{ steps.version.outputs.version }}"
      #     jq --arg version "$VERSION" '.version = $version' package.json > .package.json && mv .package.json package.json

      # - name: Publish to npm using Trusted Publishing
      #   if: steps.should-skip-cd.outputs.skip != 'true'
      #   run: |
      #     # Ensure npm is authenticated via OIDC (Trusted Publishing)
      #     # setup-node should configure this automatically with id-token: write permission
      #     # pnpm will use npm's authentication
      #     pnpm publish --no-git-checks
