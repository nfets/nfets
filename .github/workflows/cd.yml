name: CD

on:
  push:
    branches: ["main"]

permissions:
  contents: write
  id-token: write
  actions: read

jobs:
  build-native-addons:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            arch: x64
            node-version: 22.x
          - os: windows-latest
            arch: x64
            node-version: 22.x
          - os: macos-latest
            arch: arm64
            node-version: 22.x
          # - os: macos-15-intel
          #   arch: x64
          #   node-version: 22.x

    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if CD should be skipped
        id: should-skip-cd
        uses: ./.github/actions/should-skip-cd

      - name: Get platform-arch folder name
        id: get-platform-arch
        if: steps.should-skip-cd.outputs.skip != 'true'
        shell: bash
        run: |
          if [ "${{ matrix.os }}" == "ubuntu-latest" ] && [ "${{ matrix.arch }}" == "x64" ]; then
            echo "platform_arch=linux-x64" >> $GITHUB_OUTPUT
            echo "artifact_name=addons-linux-x64" >> $GITHUB_OUTPUT
          elif [ "${{ matrix.os }}" == "windows-latest" ] && [ "${{ matrix.arch }}" == "x64" ]; then
            echo "platform_arch=win32-x64" >> $GITHUB_OUTPUT
            echo "artifact_name=addons-win32-x64" >> $GITHUB_OUTPUT
          elif [ "${{ matrix.os }}" == "macos-latest" ] && [ "${{ matrix.arch }}" == "arm64" ]; then
            echo "platform_arch=darwin-arm64" >> $GITHUB_OUTPUT
            echo "artifact_name=addons-darwin-arm64" >> $GITHUB_OUTPUT
          elif [ "${{ matrix.os }}" == "macos-latest" ] && [ "${{ matrix.arch }}" == "x64" ]; then
            echo "platform_arch=darwin-x64" >> $GITHUB_OUTPUT
            echo "artifact_name=addons-darwin-x64" >> $GITHUB_OUTPUT
          else
            echo "Unsupported platform: ${{ matrix.os }} ${{ matrix.arch }}"
            exit 1
          fi

      - name: Check if artifact is expired
        id: check-artifact-expiration
        if: steps.should-skip-cd.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          ARTIFACT_NAME="${{ steps.get-platform-arch.outputs.artifact_name }}"
          ARTIFACT_CREATED_AT=$(gh api repos/${{ github.repository }}/actions/artifacts --jq ".artifacts[] | select(.name == \"$ARTIFACT_NAME\") | .created_at" | head -1 || echo "")

          if [ -z "$ARTIFACT_CREATED_AT" ]; then
            echo "Artifact $ARTIFACT_NAME not found"
            echo "artifact_exists=false" >> $GITHUB_OUTPUT
            echo "artifact_expired=true" >> $GITHUB_OUTPUT
          else
            echo "artifact_exists=true" >> $GITHUB_OUTPUT
            echo "artifact_created_at=$ARTIFACT_CREATED_AT" >> $GITHUB_OUTPUT

            PYTHON_CODE="from datetime import datetime, timezone; created = datetime.fromisoformat('$ARTIFACT_CREATED_AT'.replace('Z', '+00:00')); now = datetime.now(timezone.utc); days = (now - created).days; print(days)"
            DAYS_OLD=$(python3 -c "$PYTHON_CODE" 2>/dev/null || echo "999")

            echo "Artifact $ARTIFACT_NAME created $DAYS_OLD days ago"
            echo "artifact_days_old=$DAYS_OLD" >> $GITHUB_OUTPUT

            if [ "$DAYS_OLD" -ge 90 ]; then
              echo "Artifact expired (90+ days old)"
              echo "artifact_expired=true" >> $GITHUB_OUTPUT
            else
              echo "Artifact is still valid ($DAYS_OLD days old)"
              echo "artifact_expired=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Check if changes or artifact is expired
        id: check-changes-or-artifact-expired
        if: steps.should-skip-cd.outputs.skip != 'true'
        shell: bash
        run: |
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$LATEST_TAG" ]; then
            echo "No tags found, checking against initial commit"
            BASE_REF=$(git rev-list --max-parents=0 HEAD)
          else
            BASE_REF="$LATEST_TAG"
            echo "Comparing against latest tag: $LATEST_TAG"
          fi

          ADDONS_CHANGED=$(git diff --name-only --diff-filter=AM "$BASE_REF" HEAD -- "addons/" | wc -l | tr -d ' ')
          BINDING_CHANGED=$(git diff --name-only --diff-filter=M "$BASE_REF" HEAD -- "binding.gyp" | wc -l | tr -d ' ')

          echo "Addons folder changes: $ADDONS_CHANGED"
          echo "binding.gyp changes: $BINDING_CHANGED"

          ARTIFACT_EXPIRED="${{ steps.check-artifact-expiration.outputs.artifact_expired }}"

          if [ "$ADDONS_CHANGED" -gt 0 ] || [ "$BINDING_CHANGED" -gt 0 ] || [ "$ARTIFACT_EXPIRED" = "true" ]; then
            echo "Rebuild required: changes=$([ "$ADDONS_CHANGED" -gt 0 ] || [ "$BINDING_CHANGED" -gt 0 ] && echo "yes" || echo "no"), expired=$ARTIFACT_EXPIRED"
            echo "skip=false" >> $GITHUB_OUTPUT
          else
            echo "No rebuild needed: no changes and artifact is valid"
            echo "skip=true" >> $GITHUB_OUTPUT
          fi

      - name: Setup environment
        uses: ./.github/actions/setup-environment
        if: steps.check-changes-or-artifact-expired.outputs.skip != 'true' && steps.should-skip-cd.outputs.skip != 'true'
        with:
          os: ${{ matrix.os }}
          architecture: ${{ matrix.arch }}
          node-version: ${{ matrix.node-version }}

      - name: Build native addon
        if: steps.check-changes-or-artifact-expired.outputs.skip != 'true' && steps.should-skip-cd.outputs.skip != 'true'
        shell: bash
        run: |
          ARCH=${{ matrix.arch }} make addon

      - name: Organize addon files into platform-arch structure
        if: steps.check-changes-or-artifact-expired.outputs.skip != 'true' && steps.should-skip-cd.outputs.skip != 'true'
        shell: bash
        run: |
          PLATFORM_ARCH="${{ steps.get-platform-arch.outputs.platform_arch }}"
          ADDONS=(
            "xml_validator.node"
          )

          mkdir -p "build/addons/$PLATFORM_ARCH"

          for ADDON in "${ADDONS[@]}"; do
            if [ -f "build/Release/$ADDON" ]; then
              mv "build/Release/$ADDON" "build/addons/$PLATFORM_ARCH/$ADDON"
              echo "Moved addon to build/addons/$PLATFORM_ARCH/$ADDON"
            else
              echo "Error: $ADDON not found in build/Release/"
              exit 1
            fi
          done

      - name: Bundle Windows DLL dependencies
        if: steps.check-changes-or-artifact-expired.outputs.skip != 'true' && steps.should-skip-cd.outputs.skip != 'true' && contains(matrix.os, 'windows')
        shell: bash
        run: |
          PLATFORM_ARCH="${{ steps.get-platform-arch.outputs.platform_arch }}"
          DLL_PATH="C:/msys64/msys64/usr/bin/msys-xml2-16.dll"

          if [ -f "$DLL_PATH" ]; then
            cp "$DLL_PATH" "build/addons/$PLATFORM_ARCH/"
            echo "Bundled msys-xml2-16.dll with addon"
          else
            echo "Error: Could not find msys-xml2-16.dll to bundle"
            exit 1
          fi

      - name: Bundle Linux (x64) shared object dependencies
        if: steps.check-changes-or-artifact-expired.outputs.skip != 'true' && steps.should-skip-cd.outputs.skip != 'true' && contains(matrix.os, 'ubuntu') && contains(matrix.arch, 'x64')
        shell: bash
        run: |
          PLATFORM_ARCH="${{ steps.get-platform-arch.outputs.platform_arch }}"
          SO_PATH="/usr/lib/x86_64-linux-gnu/libxml2.so.2"

          if [ -f "$SO_PATH" ] || [ -L "$SO_PATH" ]; then
            cp -L "$SO_PATH" "build/addons/$PLATFORM_ARCH/libxml2.so.2"
            echo "Bundled libxml2.so.2 with addon"
          else
            echo "Error: Could not find libxml2.so.2 to bundle"
            exit 1
          fi

      - name: Bundle macOS (arm64) shared object dependencies
        if: steps.check-changes-or-artifact-expired.outputs.skip != 'true' && steps.should-skip-cd.outputs.skip != 'true' && contains(matrix.os, 'macos') && contains(matrix.arch, 'arm64')
        shell: bash
        run: |
          PLATFORM_ARCH="${{ steps.get-platform-arch.outputs.platform_arch }}"
          HOMEBREW_PREFIX=$(brew --prefix 2>/dev/null || echo "")

          POSSIBLE_PATHS=(
            "$HOMEBREW_PREFIX/opt/libxml2/lib/libxml2.2.dylib"
            "/opt/homebrew/opt/libxml2/lib/libxml2.2.dylib"
            "/usr/local/opt/libxml2/lib/libxml2.2.dylib"
          )

          SO_PATH=""
          for path in "${POSSIBLE_PATHS[@]}"; do
            if [ -f "$path" ] || [ -L "$path" ]; then
              SO_PATH="$path"
              echo "Found libxml2.dylib at: $SO_PATH"
              break
            fi
          done

          if [ -z "$SO_PATH" ]; then
            echo "Error: Could not find libxml2.dylib to bundle"
            echo "Searched paths:"
            for path in "${POSSIBLE_PATHS[@]}"; do
              echo "  - $path"
            done
            echo "Searching system for libxml2.2.dylib..."
            find /opt /usr -name "libxml2.2.dylib" 2>/dev/null | head -10
            exit 1
          fi

          cp -L "$SO_PATH" "build/addons/$PLATFORM_ARCH/libxml2.dylib"
          echo "Bundled libxml2.dylib with addon"

      - name: Verify binaries
        if: steps.check-changes-or-artifact-expired.outputs.skip != 'true' && steps.should-skip-cd.outputs.skip != 'true'
        shell: bash
        run: |
          PLATFORM_ARCH="${{ steps.get-platform-arch.outputs.platform_arch }}"
          FILES=$(find build/addons/$PLATFORM_ARCH -name "*.node" 2>/dev/null || echo "")

          if [ -n "$FILES" ]; then
            for file in $FILES; do
              file $file || echo "file command not available"
            done
          else
            echo "Warning: No .node files found in build/addons/$PLATFORM_ARCH"
          fi

      - name: Upload artifact
        if: steps.check-changes-or-artifact-expired.outputs.skip != 'true' && steps.should-skip-cd.outputs.skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.get-platform-arch.outputs.artifact_name }}
          path: build/addons/${{ steps.get-platform-arch.outputs.platform_arch }}/*
          retention-days: 90

  build-and-deploy:
    needs: build-native-addons
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            arch: x64

    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if CD should be skipped
        id: should-skip-cd
        uses: ./.github/actions/should-skip-cd

      - name: Setup environment
        uses: ./.github/actions/setup-environment
        if: steps.should-skip-cd.outputs.skip != 'true'
        with:
          os: ${{ matrix.os }}

      - name: Setup Node.js
        uses: ./.github/actions/setup-nodejs
        if: steps.should-skip-cd.outputs.skip != 'true'
        with:
          os: ${{ matrix.os }}
          node-version: 22.x
          architecture: ${{ matrix.arch }}

      - name: Install dependencies and Build package
        if: steps.should-skip-cd.outputs.skip != 'true'
        run: |
          make install
          make build

      - name: Get next version for release
        if: steps.should-skip-cd.outputs.skip != 'true'
        id: version
        run: |
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$LATEST_TAG" ]; then
            CURRENT_VERSION=$(jq -r '.version' package.json)
            echo "No tags found, using package.json version: $CURRENT_VERSION"
          else
            CURRENT_VERSION="${LATEST_TAG#v}"
            echo "Latest tag: $LATEST_TAG, version: $CURRENT_VERSION"
          fi

          IFS='.' read -r -a VERSION_PARTS <<< "$CURRENT_VERSION"
          MAJOR="${VERSION_PARTS[0]:-0}"
          MINOR="${VERSION_PARTS[1]:-0}"
          PATCH="${VERSION_PARTS[2]:-0}"

          NEW_PATCH=$((PATCH + 1))
          NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"

          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Configure Git
        if: steps.should-skip-cd.outputs.skip != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - run: mkdir -p build/addons

      - name: Download artifacts
        if: steps.should-skip-cd.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          ARTIFACTS=(
            "addons-linux-x64"
            "addons-win32-x64"
            "addons-darwin-arm64"
          )

          for ARTIFACT_NAME in "${ARTIFACTS[@]}"; do
            PLATFORM_ARCH=$(echo "$ARTIFACT_NAME" | sed 's/^addons-//')
            TARGET_DIR="build/addons/$PLATFORM_ARCH"

            echo "Downloading artifact $ARTIFACT_NAME..."

            DOWNLOAD_URL=$(gh api repos/${{ github.repository }}/actions/artifacts \
              --jq ".artifacts[] | select(.name == \"$ARTIFACT_NAME\" and .expired == false) | .archive_download_url" \
              | head -1)

            if [ -z "$DOWNLOAD_URL" ]; then
              echo "Warning: No valid artifact found for $ARTIFACT_NAME"
              continue
            fi

            curl -L -H "Authorization: token ${GH_TOKEN}" \
              -o "/tmp/$ARTIFACT_NAME.zip" \
              "$DOWNLOAD_URL"

            unzip -q "/tmp/$ARTIFACT_NAME.zip" -d $TARGET_DIR
            rm "/tmp/$ARTIFACT_NAME.zip"
          done

      - name: Create and push tag
        if: steps.should-skip-cd.outputs.skip != 'true'
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          VERSION="${{ steps.version.outputs.version }}"

          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag $TAG already exists, skipping..."
            exit 0
          fi

          git tag -a "$TAG" -m "Release $VERSION"
          git push origin "$TAG"

      - name: Create release
        if: steps.should-skip-cd.outputs.skip != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          VERSION="${{ steps.version.outputs.version }}"

          gh release create "$TAG" \
              --repo="$GITHUB_REPOSITORY" \
              --title="${GITHUB_REPOSITORY#*/} $VERSION" \
              --generate-notes

      - name: Update package.json version
        if: steps.should-skip-cd.outputs.skip != 'true'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          jq --arg version "$VERSION" '.version = $version' package.json > .package.json && mv .package.json package.json

      - name: Publish to npm using Trusted Publishing
        if: steps.should-skip-cd.outputs.skip != 'true'
        run: |
          # Ensure npm is authenticated via OIDC (Trusted Publishing)
          # setup-node should configure this automatically with id-token: write permission
          # pnpm will use npm's authentication
          pnpm publish --no-git-checks
